# MyChat 项目结构说明

## 项目概述

MyChat 是一个基于 Go + Vue.js 的心理咨询聊天平台，采用微服务架构，将不同功能模块分离为独立服务。

## 服务架构

### 核心服务

```
┌─────────────────────────────────────────────────────────────┐
│                        用户端                             │
│                  (Web/Mobile App)                         │
└─────────────────────┬─────────────────────────────────────┘
                      │
                      ↓
        ┌───────────────────────────┐
        │    主 API 服务 (:8080)    │
        │  - 用户认证               │
        │  - 订单管理               │
        │  - 支付结算               │
        │  - 评价系统               │
        └─────────────┬─────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ↓                           ↓
┌──────────────┐          ┌──────────────────┐
│   MySQL      │          │ WebSocket 服务   │
│   (:3306)    │◄─────────│   (:8082)       │
│              │          │  - 实时聊天      │
└──────────────┘          │  - 消息推送      │
                         │  - 会话管理      │
                         └──────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      管理后台前端                         │
│                  Vue 3 (:3000)                            │
└─────────────────────┬─────────────────────────────────────┘
                      │
                      ↓
        ┌───────────────────────────┐
        │ 管理后台 API (:8081)     │
        │  - 用户管理              │
        │  - 咨询师管理            │
        │  - 订单管理              │
        │  - 财务管理              │
        │  - 聊天记录管理          │
        │  - 权限管理 (RBAC)       │
        │  - 低代码平台            │
        └─────────────┬─────────────┘
                      │
        ┌─────────────┴─────────────┐
        │                           │
        ↓                           ↓
┌──────────────┐          ┌──────────────────┐
│   MySQL      │          │ WebSocket 服务   │
│   (:3306)    │◄─────────│   (:8082)       │
│              │          │  - 聊天记录查询  │
└──────────────┘          └──────────────────┘
```

## 目录结构

```
mychat/
│
├── api/                          # 主 API 服务
│   ├── main.go                   # 服务入口
│   ├── handlers/                 # 业务处理器
│   ├── models/                   # 数据模型
│   ├── middleware/               # 中间件
│   ├── utils/                    # 工具函数
│   ├── cache/                    # 缓存操作
│   └── websocket/                # WebSocket 相关
│
├── websocket/                    # 独立 WebSocket 服务
│   ├── main.go                   # WebSocket 服务入口
│   ├── hub.go                    # 连接管理
│   ├── manager.go                # 会话管理
│   ├── message.go                # 消息处理
│   └── stats.go                  # 统计信息
│
├── admin/                        # 管理后台
│   ├── backend/                  # 管理后台后端
│   │   ├── main.go               # 服务入口
│   │   ├── handlers/             # 管理后台处理器
│   │   ├── models/               # 数据模型
│   │   ├── middleware/           # 中间件
│   │   ├── utils/                # 工具函数
│   │   ├── websocket/            # WebSocket 相关
│   │   └── cache/                # 缓存操作
│   │
│   └── frontend/                 # 管理后台前端
│       ├── index.html            # HTML 入口
│       ├── package.json          # 依赖配置
│       ├── vite.config.js        # 构建配置
│       └── src/
│           ├── api/              # API 接口
│           ├── views/            # 页面组件
│           ├── router/           # 路由配置
│           ├── stores/           # 状态管理
│           └── ...
│
├── database/                     # 共享数据库配置
├── models/                       # 共享数据模型
├── handlers/                     # 共享处理器
├── utils/                        # 共享工具函数
├── cache/                        # 共享缓存操作
├── middleware/                   # 共享中间件
├── websocket/                     # 共享 WebSocket 代码
├── config/                       # 配置文件
├── tasks/                        # 定时任务
├── uploads/                      # 上传文件目录
├── cert/                         # 证书目录
├── docs/                         # API 文档
├── go.mod                        # Go 模块
├── go.sum                        # 依赖锁定
└── README.md                     # 项目说明
```

## 服务职责

### 主 API 服务 (:8080)
- **用户认证**: 注册、登录、JWT token 管理
- **用户管理**: 个人信息、密码修改
- **订单管理**: 创建订单、查询订单、取消订单
- **支付系统**: 创建支付、支付状态查询、退款
- **评价系统**: 创建评价、查询评价、回复评价
- **通知系统**: 消息通知、已读标记
- **统计数据**: 仪表盘统计、订单统计、排行
- **配置管理**: 支付配置管理

### WebSocket 服务 (:8082)
- **实时聊天**: 用户与咨询师实时消息收发
- **会话管理**: 会话创建、结束、状态管理
- **消息推送**: 实时消息推送、广播消息
- **在线状态**: 咨询师在线状态管理
- **消息持久化**: 消息存储到数据库
- **统计信息**: 连接数、会话数统计

### 管理后台 API (:8081)
- **用户管理**: 用户列表、创建、编辑、删除、密码重置
- **咨询师管理**: 咨询师列表、创建、编辑、删除
- **订单管理**: 订单列表、状态更新、统计报表
- **聊天管理**: 会话列表、消息查询、搜索、统计
- **财务管理**: 提现审核、财务统计
- **权限管理**: 角色管理、权限管理、RBAC
- **低代码平台**: 表单设计、页面设计、数据管理
- **系统管理**: 统计数据、在线用户、系统广播

### 管理后台前端 (:3000)
- **系统管理**: 用户、咨询师、角色、权限
- **业务管理**: 订单、聊天记录
- **财务管理**: 提现审核、财务统计
- **低代码平台**: 表单设计、页面设计

## 数据流

### 用户聊天流程
```
1. 用户下单
   ↓
2. API 服务创建订单 (:8080)
   ↓
3. 用户连接 WebSocket (:8082)
   ↓
4. 咨询师接受订单，连接 WebSocket (:8082)
   ↓
5. 开始聊天，实时消息交换
   ↓
6. 消息持久化到 MySQL
   ↓
7. 会话结束，计算费用
   ↓
8. 更新订单状态
```

### 管理后台查询聊天记录
```
1. 管理员登录 (:8081)
   ↓
2. 查询会话列表
   ↓
3. 查看会话消息
   ↓
4. 从 MySQL 读取消息记录
   ↓
5. 展示在管理后台前端
```

## 技术栈

### 后端
- **语言**: Go 1.21
- **Web 框架**: Gin
- **ORM**: GORM
- **数据库**: MySQL 5.7+
- **缓存**: Redis 6.0+
- **认证**: JWT
- **实时通信**: WebSocket

### 前端
- **框架**: Vue 3
- **UI 库**: Element Plus
- **状态管理**: Pinia
- **路由**: Vue Router
- **构建工具**: Vite
- **HTTP 客户端**: Axios

## 部署架构

### 开发环境
```
本地开发机
├── API 服务 (:8080)
├── WebSocket 服务 (:8082)
├── 管理后台 API (:8081)
├── 管理后台前端 (:3000)
├── MySQL (:3306)
└── Redis (:6379)
```

### 生产环境
```
应用服务器 1
├── API 服务 (:8080)
└── WebSocket 服务 (:8082)

应用服务器 2
└── 管理后台 API (:8081)

应用服务器 3 (CDN)
└── 管理后台前端 (静态文件)

数据库服务器
├── MySQL 主从集群
└── Redis 集群

负载均衡 (Nginx)
└── 反向代理所有服务
```

## 扩展性设计

### 水平扩展
- API 服务可部署多实例，使用负载均衡
- WebSocket 服务可部署多实例，使用 Redis Pub/Sub
- 管理后台 API 可部署多实例

### 垂直扩展
- 数据库读写分离
- Redis 集群模式
- CDN 加速静态资源

## 文档索引

| 文档 | 路径 | 说明 |
|------|------|------|
| 项目说明 | `README.md` | 项目总体介绍 |
| 管理后台说明 | `ADMIN_README.md` | 管理后台使用指南 |
| 项目结构 | `PROJECT_STRUCTURE.md` | 本文档 |
| 管理后台结构 | `admin/STRUCTURE.md` | 管理后台详细结构 |
| API 服务 | `api/README.md` | API 服务文档 |
| WebSocket 服务 | `websocket/README.md` | WebSocket 服务文档 |
| 管理后台后端 | `admin/backend/README.md` | 管理后端文档 |
| 管理后台前端 | `admin/frontend/README.md` | 管理前端文档 |

## 快速开始

### 1. 启动所有服务

```bash
# 终端 1: API 服务
cd api && go run main.go

# 终端 2: WebSocket 服务
cd websocket && go run main.go

# 终端 3: 管理后台 API
cd admin/backend && go run main.go

# 终端 4: 管理后台前端
cd admin/frontend && npm run dev
```

### 2. 访问服务

| 服务 | 地址 |
|------|------|
| API 文档 | http://localhost:8080/swagger/index.html |
| 管理后台 | http://localhost:3000 |

## 开发规范

### 代码组织
- API 服务代码在 `api/` 目录
- WebSocket 服务代码在 `websocket/` 目录
- 管理后台代码在 `admin/` 目录
- 共享代码在根目录对应目录

### 命名规范
- 文件名: 小写 + 下划线 (user_handler.go)
- 函数名: 大驼峰 (GetUserList)
- 变量名: 小驼峰 (userName)
- 常量名: 大写 + 下划线 (MAX_RETRY)

### 提交规范
```
feat: 新功能
fix: 修复 bug
docs: 文档更新
style: 代码格式
refactor: 重构
test: 测试
chore: 构建/工具
```

## 常见问题

### Q: 为什么 WebSocket 独立部署？
A: WebSocket 长连接占用资源，独立部署便于扩展和管理，避免影响主 API 服务性能。

### Q: 共享代码如何管理？
A: 共享代码放在根目录，各服务通过 Go 模块引用。未来可以考虑提取为独立的共享包。

### Q: 如何保证服务间通信？
A: 使用数据库作为数据交换中心，重要操作通过消息队列或 HTTP 调用。

### Q: 前端如何连接多个后端服务？
A: 前端通过不同的 baseURL 连接不同的服务：
- 用户端: `http://localhost:8080` + `ws://localhost:8082`
- 管理后台: `http://localhost:8081` + `ws://localhost:8082`
